name: DevBuddyAI PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      checks: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install DevBuddyAI
        run: pip install devbuddy-ai

      - name: Get changed files
        id: changed-files
        run: |
          # ÂêÑË®ÄË™û„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂèñÂæó
          PY_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '\.py$' | tr '\n' ' ' || true)
          JS_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(js|jsx|ts|tsx)$' | tr '\n' ' ' || true)
          RS_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '\.rs$' | tr '\n' ' ' || true)
          GO_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '\.go$' | tr '\n' ' ' || true)

          echo "py_files=$PY_FILES" >> $GITHUB_OUTPUT
          echo "js_files=$JS_FILES" >> $GITHUB_OUTPUT
          echo "rs_files=$RS_FILES" >> $GITHUB_OUTPUT
          echo "go_files=$GO_FILES" >> $GITHUB_OUTPUT

          # ÂÖ®„Éï„Ç°„Ç§„É´ÁµêÂêà
          ALL_FILES="$PY_FILES$JS_FILES$RS_FILES$GO_FILES"
          if [ -n "$ALL_FILES" ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Run DevBuddyAI Review
        if: steps.changed-files.outputs.has_files == 'true'
        env:
          DEVBUDDY_API_KEY: ${{ secrets.DEVBUDDY_API_KEY }}
        run: |
          # „É¨„Éì„É•„ÉºÁµêÊûú„ÇíÊ†ºÁ¥ç
          REVIEW_JSON="[]"

          # Python „Éï„Ç°„Ç§„É´„É¨„Éì„É•„Éº
          if [ -n "${{ steps.changed-files.outputs.py_files }}" ]; then
            echo "Reviewing Python files..."
            devbuddy review ${{ steps.changed-files.outputs.py_files }} \
              --severity medium \
              --format json \
              -o py_review.json || true
            if [ -f py_review.json ]; then
              REVIEW_JSON=$(jq -s 'add' py_review.json <<< "$REVIEW_JSON" 2>/dev/null || echo "$REVIEW_JSON")
            fi
          fi

          # JavaScript/TypeScript „Éï„Ç°„Ç§„É´„É¨„Éì„É•„Éº
          if [ -n "${{ steps.changed-files.outputs.js_files }}" ]; then
            echo "Reviewing JavaScript/TypeScript files..."
            devbuddy review ${{ steps.changed-files.outputs.js_files }} \
              --severity medium \
              --format json \
              -o js_review.json || true
            if [ -f js_review.json ]; then
              REVIEW_JSON=$(jq -s 'add' js_review.json <<< "$REVIEW_JSON" 2>/dev/null || echo "$REVIEW_JSON")
            fi
          fi

          # Rust „Éï„Ç°„Ç§„É´„É¨„Éì„É•„Éº
          if [ -n "${{ steps.changed-files.outputs.rs_files }}" ]; then
            echo "Reviewing Rust files..."
            devbuddy review ${{ steps.changed-files.outputs.rs_files }} \
              --severity medium \
              --format json \
              -o rs_review.json || true
            if [ -f rs_review.json ]; then
              REVIEW_JSON=$(jq -s 'add' rs_review.json <<< "$REVIEW_JSON" 2>/dev/null || echo "$REVIEW_JSON")
            fi
          fi

          # Go „Éï„Ç°„Ç§„É´„É¨„Éì„É•„Éº
          if [ -n "${{ steps.changed-files.outputs.go_files }}" ]; then
            echo "Reviewing Go files..."
            devbuddy review ${{ steps.changed-files.outputs.go_files }} \
              --severity medium \
              --format json \
              -o go_review.json || true
            if [ -f go_review.json ]; then
              REVIEW_JSON=$(jq -s 'add' go_review.json <<< "$REVIEW_JSON" 2>/dev/null || echo "$REVIEW_JSON")
            fi
          fi

          # MarkdownÂΩ¢Âºè„ÅßÂá∫Âäõ„ÇÇÁîüÊàê
          devbuddy review ${{ steps.changed-files.outputs.py_files }}${{ steps.changed-files.outputs.js_files }}${{ steps.changed-files.outputs.rs_files }}${{ steps.changed-files.outputs.go_files }} \
            --severity medium \
            --format markdown \
            -o review_output.md || true

      - name: Post review comment
        if: steps.changed-files.outputs.has_files == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // MarkdownÂá∫Âäõ„ÇíË™≠„ÅøËæº„Åø
            let output = '';
            try {
              output = fs.readFileSync('review_output.md', 'utf8');
            } catch (e) {
              console.log('No review output found');
              return;
            }

            if (!output || output.includes('No issues found') || output.trim() === '') {
              console.log('No issues found, skipping comment');
              return;
            }

            // Êó¢Â≠ò„ÅÆDevBuddyAI„Ç≥„É°„É≥„Éà„ÇíÊ§úÁ¥¢
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.data.find(c =>
              c.body.includes('DevBuddyAI Code Review') &&
              c.user.login === 'github-actions[bot]'
            );

            const body = `## ü§ñ DevBuddyAI Code Review\n\n${output}\n\n---\n*Powered by [DevBuddyAI](https://github.com/masuda-hikari/DevBuddyAI)*`;

            if (existingComment) {
              // Êó¢Â≠ò„Ç≥„É°„É≥„Éà„ÇíÊõ¥Êñ∞
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              // Êñ∞Ë¶è„Ç≥„É°„É≥„Éà‰ΩúÊàê
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Create Check Run
        if: steps.changed-files.outputs.has_files == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let summary = 'No issues found';
            let conclusion = 'success';

            try {
              const output = fs.readFileSync('review_output.md', 'utf8');
              if (output && !output.includes('No issues found')) {
                // ÂïèÈ°å„ÅÆÊï∞„Çí„Ç´„Ç¶„É≥„Éà
                const issueCount = (output.match(/\*\*\[/g) || []).length;
                if (issueCount > 0) {
                  summary = `Found ${issueCount} issue(s)`;
                  conclusion = 'neutral';
                }
              }
            } catch (e) {
              // „Éï„Ç°„Ç§„É´„Å™„Åó
            }

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'DevBuddyAI Review',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: 'DevBuddyAI Code Review',
                summary: summary
              }
            });

      - name: No files to review
        if: steps.changed-files.outputs.has_files == 'false'
        run: echo "No supported files to review"
